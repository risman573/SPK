<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Geocoding Feature</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2>Test Fitur Geocoding - Cek Lokasi</h2>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Form Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="alamat" class="form-label">Alamat</label>
                            <textarea class="form-control" id="alamat" rows="3" placeholder="Masukkan alamat lengkap..."></textarea>
                            <button type="button" class="btn btn-info btn-sm mt-2" onclick="cekLokasi('alamat', 'lat', 'lon')">
                                üìç Cek Lokasi
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lat" class="form-label">Latitude</label>
                                    <input type="text" class="form-control" id="lat" placeholder="Akan terisi otomatis">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lon" class="form-label">Longitude</label>
                                    <input type="text" class="form-control" id="lon" placeholder="Akan terisi otomatis">
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <h6>Test Alamat Praktek</h6>
                        <div class="mb-3">
                            <label for="praktek" class="form-label">Tempat Praktek</label>
                            <input type="text" class="form-control" id="praktek" placeholder="Nama tempat praktek">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="kota" class="form-label">Kota</label>
                                    <input type="text" class="form-control" id="kota" placeholder="Nama kota">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="provinsi" class="form-label">Provinsi</label>
                                    <input type="text" class="form-control" id="provinsi" placeholder="Nama provinsi">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lat_praktek" class="form-label">Latitude Praktek</label>
                                    <input type="text" class="form-control" id="lat_praktek" placeholder="Auto-fill">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lon_praktek" class="form-label">Longitude Praktek</label>
                                    <input type="text" class="form-control" id="lon_praktek" placeholder="Auto-fill">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-info btn-sm" onclick="cekLokasiPraktek('praktek', 'kota', 'provinsi', 'lat_praktek', 'lon_praktek')">
                            üìç Cek Lokasi Praktek
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Hasil Test</h5>
                    </div>
                    <div class="card-body">
                        <div id="result" class="alert alert-info">
                            Hasil geocoding akan muncul di sini...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="geocoding-loading" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h5>Mencari Lokasi...</h5>
                <p class="mb-0">Mohon tunggu, sedang memproses alamat</p>
            </div>
        </div>
    </div>

    <!-- Modal Map -->
    <div class="modal fade" id="modal_map" tabindex="-1" role="dialog" aria-labelledby="modalMapLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMapLabel">Pilih Lokasi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading state inside modal -->
                    <div id="map-loading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h6>Memuat peta...</h6>
                        <p class="text-muted">Sedang mencari koordinat lokasi</p>
                    </div>
                    
                    <!-- Map content -->
                    <div id="map-content">
                        <div class="alert alert-info">
                            <strong>Petunjuk:</strong> Klik dan drag marker merah untuk mengatur posisi yang tepat, atau klik di peta untuk memindahkan marker.
                        </div>
                        <div id="map" style="height: 400px; width: 100%;"></div>
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Latitude:</label>
                                    <input type="text" id="temp_lat" class="form-control" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label>Longitude:</label>
                                    <input type="text" id="temp_lon" class="form-control" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="confirmLocation()" id="confirm-location-btn">Gunakan Lokasi Ini</button>
                </div>
            </div>
        </div>
    </div>

    <style>
    /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1070 !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    .loading-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 300px;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

        /* Modal backdrop enhancement */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8) !important;
        }

        /* Map modal specific styling */
        #modal_map .modal-content {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* Prevent scroll issues when modal is open */
        body.modal-open {
            overflow: hidden;
            padding-right: 0 !important;
        }    /* Button loading state */
    .btn-loading {
        position: relative;
        pointer-events: none;
    }

    .btn-loading::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid transparent;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    </style>

    <script>
        // Variables for map functionality
        var map, marker, currentLatField, currentLonField;
        var baseUrl = 'http://localhost:8080/'; // Adjust this to your local server URL

        // Initialize map when modal is shown
        $('#modal_map').on('shown.bs.modal', function() {
            if (!map) {
                // Initialize map centered on Indonesia
                map = L.map('map').setView([-6.2, 106.816666], 10);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // Add marker
                marker = L.marker([-6.2, 106.816666], {
                    draggable: true
                }).addTo(map);
                
                // Update coordinates when marker is dragged
                marker.on('dragend', function(e) {
                    var position = marker.getLatLng();
                    $('#temp_lat').val(position.lat.toFixed(6));
                    $('#temp_lon').val(position.lng.toFixed(6));
                });
                
                // Add click event to map
                map.on('click', function(e) {
                    marker.setLatLng(e.latlng);
                    $('#temp_lat').val(e.latlng.lat.toFixed(6));
                    $('#temp_lon').val(e.latlng.lng.toFixed(6));
                });
            }
            
            // Resize map to handle modal display issues
            setTimeout(function() {
                map.invalidateSize();
            }, 200);
        });

        // Function to check location for main address
        function cekLokasi(alamatField, latField, lonField) {
            var alamat = $('#' + alamatField).val().trim();
            
            if (!alamat) {
                alert('Silakan isi alamat terlebih dahulu!');
                return;
            }
            
            // Store field references
            currentLatField = latField;
            currentLonField = lonField;
            
            // Show loading overlay
            showGeocodingLoading();
            
            // Call geocoding API
            geocodeAddress(alamat);
        }

        // Function to check location for practice address
        function cekLokasiPraktek(praktekField, kotaField, provinsiField, latField, lonField) {
            var praktek = $('#' + praktekField).val().trim();
            var kota = $('#' + kotaField).val().trim();
            var provinsi = $('#' + provinsiField).val().trim();
            
            // Build address string
            var alamat = '';
            if (praktek) alamat += praktek + ', ';
            if (kota) alamat += kota + ', ';
            if (provinsi) alamat += provinsi + ', ';
            alamat += 'Indonesia';
            
            if (!praktek && !kota && !provinsi) {
                alert('Silakan isi minimal tempat praktek, kota, atau provinsi!');
                return;
            }
            
            // Store field references
            currentLatField = latField;
            currentLonField = lonField;
            
            // Show loading overlay
            showGeocodingLoading();
            
            // Call geocoding API
            geocodeAddress(alamat);
        }

        // Function to geocode address using server-side API
        function geocodeAddress(address) {
            $.ajax({
                url: baseUrl + 'geocoding/test',
                type: 'GET',
                data: {
                    address: address
                },
                dataType: 'json',
                beforeSend: function() {
                    // Show map loading inside modal after it opens
                    showMapLoading();
                },
                success: function(response) {
                    // Hide loading overlay and show modal
                    hideGeocodingLoading();
                    
                    $('#modalMapLabel').text('Pilih Lokasi - ' + address);
                    $('#modal_map').modal('show');
                    $('#result').html('<pre>' + JSON.stringify(response, null, 2) + '</pre>');
                    
                    // Hide map loading and show content
                    hideMapLoading();
                    
                    if (response.status === 'success' && response.coordinates) {
                        var lat = response.coordinates.lat;
                        var lon = response.coordinates.lon;
                        
                        // Update map view and marker
                        map.setView([lat, lon], 15);
                        marker.setLatLng([lat, lon]);
                        
                        // Update temporary coordinates
                        $('#temp_lat').val(lat.toFixed(6));
                        $('#temp_lon').val(lon.toFixed(6));
                        
                        toaster('Success', 'Lokasi ditemukan! Anda dapat menggeser marker untuk penyesuaian.', 'success');
                    } else {
                        // If geocoding fails, center on Indonesia
                        map.setView([-6.2, 106.816666], 10);
                        marker.setLatLng([-6.2, 106.816666]);
                        $('#temp_lat').val(-6.2);
                        $('#temp_lon').val(106.816666);
                        
                        alert('Lokasi tidak ditemukan secara otomatis. Silakan klik di peta untuk menandai lokasi yang tepat.');
                    }
                },
                error: function(xhr, status, error) {
                    // Hide loading overlay
                    hideGeocodingLoading();
                    
                    $('#modalMapLabel').text('Pilih Lokasi - Error');
                    $('#modal_map').modal('show');
                    $('#result').html('<div class="alert alert-danger">Error: ' + error + '</div>');
                    
                    // Hide map loading and show content
                    hideMapLoading();
                    
                    // Center on Indonesia
                    map.setView([-6.2, 106.816666], 10);
                    marker.setLatLng([-6.2, 106.816666]);
                    $('#temp_lat').val(-6.2);
                    $('#temp_lon').val(106.816666);
                    
                    alert('Terjadi kesalahan saat mencari lokasi. Silakan pilih lokasi secara manual di peta.');
                }
            });
        }

        // Function to confirm location selection
        function confirmLocation() {
            var lat = $('#temp_lat').val();
            var lon = $('#temp_lon').val();
            
            if (!lat || !lon) {
                alert('Koordinat tidak valid. Silakan pilih lokasi di peta.');
                return;
            }
            
            // Show button loading state
            var $btn = $('#confirm-location-btn');
            $btn.addClass('btn-loading').prop('disabled', true);
            var originalText = $btn.text();
            $btn.text('Menyimpan...');
            
            // Simulate processing time
            setTimeout(function() {
                // Update the target fields
                $('#' + currentLatField).val(lat);
                $('#' + currentLonField).val(lon);
                
                // Reset button state
                $btn.removeClass('btn-loading').prop('disabled', false).text(originalText);
                
                // Close modal
                $('#modal_map').modal('hide');
                
                // Show success message
                alert('Koordinat lokasi berhasil diperbarui!');
            }, 800);
        }

        // Loading helper functions
        function showGeocodingLoading() {
            $('#geocoding-loading').fadeIn(300);
        }

        function hideGeocodingLoading() {
            $('#geocoding-loading').fadeOut(300);
        }

        function showMapLoading() {
            $('#map-loading').show();
            $('#map-content').hide();
            $('#confirm-location-btn').prop('disabled', true);
        }

        function hideMapLoading() {
            $('#map-loading').hide();
            $('#map-content').show();
            $('#confirm-location-btn').prop('disabled', false);
        }

        // Enhanced modal event handlers
        $('#modal_map').on('show.bs.modal', function() {
            // Reset modal state
            hideMapLoading();
        });

        $('#modal_map').on('hidden.bs.modal', function() {
            // Reset any loading states when modal is closed
            hideMapLoading();
            $('#confirm-location-btn').removeClass('btn-loading').prop('disabled', false).text('Gunakan Lokasi Ini');
        });

        // Simple toaster function replacement
        function toaster(title, message, type) {
            alert(title + ': ' + message);
        }
    </script>
</body>
</html>